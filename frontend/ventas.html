<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Historial de ventas | POS Farmacia</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .actions-top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
    .pill b{font-weight:800}
    .muted{color:#64748b}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi .pill{background:#f8fafc}
    .okmsg{color:#16a34a;margin-top:8px}
    .errmsg{color:#ef4444;margin-top:8px}
  </style>
</head>
<body> 
<header>
  <div class="brand">
    Historial de ventas <span class="badge" id="roleTag" style="margin-left:8px;"></span>
  </div>
  <div class="right">
    <a class="link" href="dashboard.html">Dashboard</a>
    <a class="link" href="pos.html" data-role="admin,cajero">Caja</a>
    <a class="link" href="admin_productos.html" data-role="admin">Productos</a>
    <a class="link" href="usuarios.html" data-role="admin">Usuarios</a>
    <button class="secondary" onclick="logout()">Salir</button>
  </div>
</header>

<div class="container">
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center;gap:12px;">
      <div>
        <h2 style="margin-bottom:6px;">Filtro</h2>
        <div class="small muted">Filtra por fechas y exporta a Excel.</div>
      </div>

      <div class="actions-top">
        <button class="btn" id="btnExcel" data-role="admin,cajero">Excel Ventas</button>
        <button class="secondary" id="btnLoad">Buscar</button>
        <button id="btnToday">Hoy</button>
        <button class="secondary" id="btn7">√ölt. 7 d√≠as</button>
        <button class="secondary" id="btnMonth">Este mes</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <input id="from" type="date" />
      <input id="to" type="date" />
    </div>

    <div class="kpi" id="kpi">
      <span class="pill">üìÑ Ventas: <b id="kpiCount">0</b></span>
      <span class="pill">üí∞ Total vendido: <b>S/ <span id="kpiTotal">0.00</span></b></span>
    </div>

    <p id="msgErr" class="small errmsg" style="display:none;"></p>
    <p id="msgOk" class="small okmsg" style="display:none;"></p>
  </section>

  <section class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <h2>Ventas</h2>
      <div class="small muted" id="rangeLabel"></div>
    </div>

    <table class="table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>#</th>
          <th>Fecha</th>
          <th>Pago</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="small muted" style="margin-top:10px;">
      Tip: haz clic en ‚ÄúVer‚Äù para abrir el detalle y reimprimir.
    </div>
  </section>
</div>

<!-- Modal -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); padding:30px; overflow:auto;">
  <div class="card" style="max-width:900px; margin:auto;">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h2>Detalle de venta</h2>
      <button class="secondary" id="btnClose">Cerrar</button>
    </div>
    <p id="meta" class="small"></p>
    <div id="items"></div>
    <hr/>
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="total">Total: S/ <span id="total">0.00</span></div>
      <button id="btnPrint">Reimprimir ticket</button>
    </div>

<!-- Ticket t√©rmico (80mm por defecto) -->
<div id="ticket" style="display:none;">
  <div class="t58" id="ticketPaper">
    <div class="t-center">
      <div class="t-title">FARMACIA</div>
      <div class="t-sub" id="ticketHeaderExtra">RUC: ‚Äî ¬∑ Direcci√≥n: ‚Äî</div>
      <div class="t-sub" id="ticketMeta"></div>
    </div>

    <div class="t-hr"></div>

    <div class="t-cols t-muted">
      <div class="w-name">Producto</div>
      <div class="w-qty t-right">Cant</div>
      <div class="w-sub t-right">Sub</div>
    </div>

    <div id="ticketItems"></div>

    <div class="t-hr"></div>

    <div class="t-row t-bold">
      <div>TOTAL</div>
      <div class="t-right">S/ <span id="ticketTotal"></span></div>
    </div>

    <div class="t-hr"></div>

    <div class="t-center t-muted" style="margin-top:10px">
      Gracias por su compra.
    </div>
  </div>
</div>

<style>
  /* ===== Ticket t√©rmico ===== */
  .t80{ width:80mm; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#000; }
  .t58{ width:58mm; padding:8px; font-family: ui-monospace, monospace; color:#000; }

  .t-center{text-align:center}
  .t-right{text-align:right}
  .t-title{ font-size:18px; font-weight:900; letter-spacing:.5px; }
  .t-sub{ font-size:11px; margin-top:3px; }
  .t-muted{ color:#111; opacity:.85; font-size:11px }
  .t-bold{ font-weight:900; }
  .t-hr{ border-top:1px dashed #000; margin:8px 0; }
  .t-row{ display:flex; justify-content:space-between; gap:10px; font-size:12px; }
  .t-cols{ display:flex; gap:6px; font-size:11px; margin-bottom:6px; }
  .t-line{ display:flex; gap:6px; font-size:12px; margin:2px 0; }
  .w-name{ flex: 1 1 auto; min-width:0; }
  .w-qty{ width:10mm; }
  .w-sub{ width:18mm; }
  .t-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  @media print { body{ margin:0; } }
</style>
  
  </div>
</div>

<script src="app.js"></script>
<script>
  requireAuth(["admin","cajero"]);
  applyRoleVisibility();

  const $from = document.getElementById("from");
  const $to   = document.getElementById("to");
  const $msgErr = document.getElementById("msgErr");
  const $msgOk  = document.getElementById("msgOk");

  function showErr(t){
    $msgOk.style.display="none";
    $msgErr.textContent = t;
    $msgErr.style.display = "block";
  }
  function showOk(t){
    $msgErr.style.display="none";
    $msgOk.textContent = t;
    $msgOk.style.display = "block";
    setTimeout(()=>{ $msgOk.style.display="none"; }, 2500);
  }

  // Helpers fecha
  function ymd(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const dd = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function setRangeLabel(){
    const f = $from.value;
    const t = $to.value;
    const el = document.getElementById("rangeLabel");
    if (f && t) el.textContent = `Rango: ${f} ‚Üí ${t}`;
    else if (f) el.textContent = `Desde: ${f}`;
    else if (t) el.textContent = `Hasta: ${t}`;
    else el.textContent = `√öltimas ventas`;
  }

  // KPI desde la tabla renderizada por ventas.js
  function recomputeKPIs(){
    const tb = document.getElementById("rows");
    const trs = tb.querySelectorAll("tr");
    let count = 0;
    let sum = 0;

    trs.forEach(tr=>{
      const tds = tr.querySelectorAll("td");
      if (tds.length >= 4){
        const totalTxt = (tds[3].textContent || "").replace("S/","").trim();
        const n = Number(totalTxt.replace(",",".")) || 0;
        if (!isNaN(n)){
          count++;
          sum += n;
        }
      }
    });

    document.getElementById("kpiCount").textContent = String(count);
    document.getElementById("kpiTotal").textContent = money(sum);
  }

  // ‚úÖ Export Excel ventas (1 clic)
  async function exportVentas(){
    try{
      // Si no hay fechas, exporta HOY por defecto (mejor UX)
      if (!$from.value || !$to.value){
        const today = ymd(new Date());
        $from.value = today;
        $to.value = today;
        setRangeLabel();
      }

      const f = $from.value;
      const t = $to.value;
      if (!f || !t) return showErr("Selecciona fechas v√°lidas.");

      const params = new URLSearchParams();
      params.set("from", f);
      params.set("to", t);

      // ‚úÖ Requiere backend:
      // GET /api/export/sales.xlsx?from=YYYY-MM-DD&to=YYYY-MM-DD
      showOk("Generando Excel...");
      await downloadExcel(`/api/export/sales.xlsx?${params.toString()}`, `ventas_${f}_a_${t}.xlsx`);
      showOk("‚úÖ Excel descargado.");
    }catch(e){
      console.error(e);
      showErr("No se pudo exportar Excel: " + e.message);
    }
  }

  document.getElementById("btnExcel").onclick = exportVentas;

  // R√°pidos
  document.getElementById("btnToday").onclick = ()=>{
    const today = ymd(new Date());
    $from.value = today;
    $to.value = today;
    setRangeLabel();
    document.getElementById("btnLoad").click();
  };

  document.getElementById("btn7").onclick = ()=>{
    const now = new Date();
    const from = new Date(now.getTime() - 6*24*60*60*1000);
    $from.value = ymd(from);
    $to.value = ymd(now);
    setRangeLabel();
    document.getElementById("btnLoad").click();
  };

  document.getElementById("btnMonth").onclick = ()=>{
    const now = new Date();
    const from = new Date(now.getFullYear(), now.getMonth(), 1);
    $from.value = ymd(from);
    $to.value = ymd(now);
    setRangeLabel();
    document.getElementById("btnLoad").click();
  };

  $from.addEventListener("change", setRangeLabel);
  $to.addEventListener("change", setRangeLabel);

  // Default: HOY
  const today = ymd(new Date());
  if (!$from.value) $from.value = today;
  if (!$to.value) $to.value = today;
  setRangeLabel();

  // Hook: cuando ventas.js termine de renderizar
  window.__afterVentasRender = () => {
    setRangeLabel();
    recomputeKPIs();
  };
</script>

<!-- ventas.js sigue siendo el que controla la carga/render + modal -->
<script src="ventas.js"></script>
</body>
</html>
