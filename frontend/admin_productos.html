<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Productos | POS Farmacia</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .actions-top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
    .pill b{font-weight:800}
    .pill.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .pill.danger{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    .table td .small{margin-top:4px}
    .muted{color:#64748b}
  </style>
</head>
<body>
<header>
  <div class="brand">
    Productos <span class="badge" id="roleTag" style="margin-left:8px;"></span>
  </div>

  <div class="right">
    <a class="link" href="dashboard.html">Dashboard</a>
    <a class="link" href="pos.html">Caja</a>
    <a class="link" href="ventas.html">Historial</a>
    <a class="link" href="usuarios.html" data-role="admin">Usuarios</a>
    <button class="secondary" onclick="logout()">Salir</button>
  </div>
</header>

<div class="container">

  <!-- ‚úÖ ALERTAS + ACCIONES -->
  <div class="card" style="margin-bottom:14px;" data-role="admin">
    <div class="row" style="justify-content:space-between;align-items:center;gap:12px;">
      <div>
        <h2 style="margin-bottom:6px;">Alertas r√°pidas</h2>
        <div class="small muted">Stock bajo y exportaci√≥n para Excel (impacto comercial inmediato).</div>
      </div>

      <div class="actions-top">
        <button class="btn" id="btnExcelInv" data-role="admin">Excel Inventario</button>
        <a class="btn" href="dashboard.html">Ver Dashboard</a>
      </div>
    </div>

    <div style="margin-top:12px;" id="alertWrap">
      <span class="pill" id="pillLow">‚è≥ Cargando alertas‚Ä¶</span>
    </div>

    <div class="small" style="margin-top:10px;color:#64748b;">
      Regla: <b>Stock bajo</b> = productos con stock &lt; <b>5</b>
    </div>
  </div>

  <div class="card">
    <h2>Nuevo / Editar producto</h2>
    <p class="small">
      Tip: usa un c√≥digo simple (o c√≥digo de barras).
      <b>Alerta</b>: si un producto vence pronto, lo resaltaremos en la lista.
    </p>

    <input type="hidden" id="id"/>

    <div class="row">
      <input id="code" placeholder="C√≥digo (√∫nico)"/>
      <input id="name" placeholder="Nombre"/>
      <input id="lab" placeholder="Laboratorio (opcional)"/>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="location" placeholder="Ubicaci√≥n (Ej: Estante A-3)" />
      <input id="expiry_date" type="date" placeholder="Vencimiento" />
      <input id="stock" placeholder="Stock" type="number" min="0"/>
      <input id="buy_price" placeholder="Precio compra" type="number" step="0.01" min="0"/>
      <input id="sell_price" placeholder="Precio venta" type="number" step="0.01" min="0"/>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnSave">Guardar</button>
      <button class="secondary" id="btnClear">Limpiar</button>
      <span id="msg" class="small" style="color:#ef4444"></span>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Lista</h2>
      <input id="search" placeholder="Buscar por nombre o c√≥digo..."/>
    </div>

    <table class="table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Nombre</th>
          <th>Ubicaci√≥n</th>
          <th>Vence</th>
          <th>Stock</th>
          <th>P. Venta</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <p class="small" style="margin-top:10px;">
      üü† Naranja = vence en ‚â§ 30 d√≠as ¬∑ üî¥ Rojo = vencido
    </p>
  </div>
</div>

<script src="app.js"></script>
<script>
  requireAuth(["admin"]);
  applyRoleVisibility();

  let products = [];

  const LOW_LIMIT = 5;

  function daysTo(expiry) {
    if (!expiry) return null;
    const d = new Date(expiry + "T00:00:00");
    if (isNaN(d.getTime())) return null;
    const now = new Date();
    const diff = Math.ceil((d.getTime() - now.getTime()) / (1000*60*60*24));
    return diff;
  }

  async function load(){
    const q = $("search").value.trim();
    products = await api("/api/products?search="+encodeURIComponent(q));
    render();
  }

  function render(){
    const tb = $("tbody");
    tb.innerHTML = "";

    for(const p of products){
      const tr = document.createElement("tr");

      const d = daysTo(p.expiry_date);
      let venceTxt = p.expiry_date || "";
      let venceBadge = "";

      if (d !== null) {
        if (d < 0) venceBadge = `<span class="badge" style="background:#ef4444;color:white;">VENCIDO</span>`;
        else if (d <= 30) venceBadge = `<span class="badge" style="background:#f59e0b;color:white;">${d} d√≠as</span>`;
        else venceBadge = `<span class="badge">${d} d√≠as</span>`;
      }

      // Badge stock (m√°s claro)
      const stockBadge = (Number(p.stock) <= 0)
        ? `<span class="badge" style="background:#ef4444;color:white;">${p.stock}</span>`
        : (Number(p.stock) < LOW_LIMIT)
          ? `<span class="badge" style="background:#f59e0b;color:white;">${p.stock}</span>`
          : `<span class="badge">${p.stock}</span>`;

      tr.innerHTML = `
        <td>${p.code}</td>
        <td>${p.name} <div class="small">${p.lab||""}</div></td>
        <td>${p.location || ""}</td>
        <td>${venceTxt} ${venceBadge}</td>
        <td>${stockBadge}</td>
        <td>S/ ${money(p.sell_price)}</td>
        <td>
          <button class="secondary" onclick='edit(${p.id})'>Editar</button>
          <button class="danger" onclick='del(${p.id})'>Eliminar</button>
        </td>
      `;

      // Resaltar fila por vencimiento
      if (d !== null) {
        if (d < 0) tr.style.background = "rgba(239,68,68,0.10)";
        else if (d <= 30) tr.style.background = "rgba(245,158,11,0.10)";
      }

      tb.appendChild(tr);
    }

    if(products.length===0){
      tb.innerHTML = `<tr><td colspan="7" class="small">No hay productos</td></tr>`;
    }
  }

  function edit(id){
    const p = products.find(x=>x.id===id);
    $("id").value = p.id;
    $("code").value = p.code;
    $("name").value = p.name;
    $("lab").value = p.lab||"";
    $("location").value = p.location||"";
    $("stock").value = p.stock;
    $("buy_price").value = p.buy_price;
    $("sell_price").value = p.sell_price;
    $("expiry_date").value = p.expiry_date || "";
    window.scrollTo({top:0,behavior:"smooth"});
  }

  async function del(id){
    if(!confirm("¬øEliminar producto?")) return;
    await api("/api/products/"+id, { method:"DELETE" });
    await load();
    await loadAlerts();
  }

  $("btnSave").onclick = async ()=>{
    $("msg").textContent="";
    try{
      const payload = {
        code: $("code").value.trim(),
        name: $("name").value.trim(),
        lab: $("lab").value.trim(),
        location: $("location").value.trim(),
        stock: Number($("stock").value||0),
        buy_price: Number($("buy_price").value||0),
        sell_price: Number($("sell_price").value||0),
        expiry_date: $("expiry_date").value.trim() || null
      };

      const id = $("id").value;
      if(id){
        await api("/api/products/"+id, { method:"PUT", body: JSON.stringify(payload) });
      }else{
        await api("/api/products", { method:"POST", body: JSON.stringify(payload) });
      }
      clearForm();
      await load();
      await loadAlerts();
    }catch(e){
      $("msg").textContent = e.message;
    }
  };

  function clearForm(){
    $("id").value="";
    $("code").value="";
    $("name").value="";
    $("lab").value="";
    $("location").value="";
    $("stock").value="0";
    $("buy_price").value="0";
    $("sell_price").value="0";
    $("expiry_date").value="";
  }

  $("btnClear").onclick = clearForm;
  $("search").oninput = ()=>load();

  // ‚úÖ Excel inventario
  const btnExcelInv = document.getElementById("btnExcelInv");
  if (btnExcelInv) {
    btnExcelInv.onclick = () => downloadExcel("/api/export/products.xlsx", "inventario.xlsx");
  }

  // ‚úÖ Alertas stock bajo
  function setPill(el, text, cls){
    el.className = "pill " + (cls||"");
    el.innerHTML = text;
  }

  async function loadAlerts(){
    const pill = document.getElementById("pillLow");
    try{
      const low = await api(`/api/alerts/low-stock?limit=${LOW_LIMIT}`);
      if ((low.count || 0) === 0){
        setPill(pill, "‚úÖ Sin stock bajo", "ok");
      } else {
        // muestra top 3
        const top = (low.items||[]).slice(0,3).map(x=>`${x.name} (${x.stock})`).join(" ¬∑ ");
        const cls = (low.items||[]).some(x=>Number(x.stock)<=0) ? "danger" : "warn";
        setPill(pill, `‚ö†Ô∏è Stock bajo: <b>${low.count}</b> ¬∑ ${top}${low.count>3 ? "‚Ä¶" : ""}`, cls);
      }
    }catch(e){
      setPill(pill, "‚ö†Ô∏è No se pudo cargar alertas", "warn");
    }
  }

  load();
  loadAlerts();
</script>
</body>
</html>
