<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Productos | POS Farmacia</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="brand">
    Productos <span class="badge" id="roleTag" style="margin-left:8px;"></span>
  </div>

  <div class="right">
    <a class="link" href="pos.html">Caja</a>
    <a class="link" href="ventas.html">Historial</a>
    <a class="link" href="usuarios.html" data-role="admin">Usuarios</a>
    <button class="secondary" onclick="logout()">Salir</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>Nuevo / Editar producto</h2>
    <p class="small">
      Tip: usa un cÃ³digo simple (o cÃ³digo de barras).  
      <b>Alerta</b>: si un producto vence pronto, lo resaltaremos en la lista.
    </p>

    <input type="hidden" id="id"/>

    <div class="row">
      <input id="code" placeholder="CÃ³digo (Ãºnico)"/>
      <input id="name" placeholder="Nombre"/>
      <input id="lab" placeholder="Laboratorio (opcional)"/>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="location" placeholder="UbicaciÃ³n (Ej: Estante A-3)" />
      <input id="expiry_date" type="date" placeholder="Vencimiento" />
      <input id="stock" placeholder="Stock" type="number" min="0"/>
      <input id="buy_price" placeholder="Precio compra" type="number" step="0.01" min="0"/>
      <input id="sell_price" placeholder="Precio venta" type="number" step="0.01" min="0"/>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnSave">Guardar</button>
      <button class="secondary" id="btnClear">Limpiar</button>
      <span id="msg" class="small" style="color:#ef4444"></span>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Lista</h2>
      <input id="search" placeholder="Buscar por nombre o cÃ³digo..."/>
    </div>

    <table class="table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>CÃ³digo</th>
          <th>Nombre</th>
          <th>UbicaciÃ³n</th>
          <th>Vence</th>
          <th>Stock</th>
          <th>P. Venta</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <p class="small" style="margin-top:10px;">
      ðŸŸ  Naranja = vence en â‰¤ 30 dÃ­as Â· ðŸ”´ Rojo = vencido
    </p>
  </div>
</div>

<script src="app.js"></script>
<script>
  requireAuth(["admin"]);
  applyRoleVisibility();

  let products = [];

  function daysTo(expiry) {
    if (!expiry) return null;
    const d = new Date(expiry + "T00:00:00");
    if (isNaN(d.getTime())) return null;
    const now = new Date();
    const diff = Math.ceil((d.getTime() - now.getTime()) / (1000*60*60*24));
    return diff;
  }

  async function load(){
    const q = $("search").value.trim();
    products = await api("/api/products?search="+encodeURIComponent(q));
    render();
  }

  function render(){
    const tb = $("tbody");
    tb.innerHTML = "";

    for(const p of products){
      const tr = document.createElement("tr");

      const d = daysTo(p.expiry_date);
      let venceTxt = p.expiry_date || "";
      let venceBadge = "";

      if (d !== null) {
        if (d < 0) venceBadge = `<span class="badge" style="background:#ef4444;color:white;">VENCIDO</span>`;
        else if (d <= 30) venceBadge = `<span class="badge" style="background:#f59e0b;color:white;">${d} dÃ­as</span>`;
        else venceBadge = `<span class="badge">${d} dÃ­as</span>`;
      }

      tr.innerHTML = `
        <td>${p.code}</td>
        <td>${p.name} <div class="small">${p.lab||""}</div></td>
        <td>${p.location || ""}</td>
        <td>${venceTxt} ${venceBadge}</td>
        <td><span class="badge">${p.stock}</span></td>
        <td>S/ ${money(p.sell_price)}</td>
        <td>
          <button class="secondary" onclick='edit(${p.id})'>Editar</button>
          <button class="danger" onclick='del(${p.id})'>Eliminar</button>
        </td>
      `;

      // Resaltar fila
      if (d !== null) {
        if (d < 0) tr.style.background = "rgba(239,68,68,0.10)";
        else if (d <= 30) tr.style.background = "rgba(245,158,11,0.10)";
      }

      tb.appendChild(tr);
    }

    if(products.length===0){
      tb.innerHTML = `<tr><td colspan="7" class="small">No hay productos</td></tr>`;
    }
  }

  function edit(id){
    const p = products.find(x=>x.id===id);
    $("id").value = p.id;
    $("code").value = p.code;
    $("name").value = p.name;
    $("lab").value = p.lab||"";
    $("location").value = p.location||"";
    $("stock").value = p.stock;
    $("buy_price").value = p.buy_price;
    $("sell_price").value = p.sell_price;
    $("expiry_date").value = p.expiry_date || "";
    window.scrollTo({top:0,behavior:"smooth"});
  }

  async function del(id){
    if(!confirm("Â¿Eliminar producto?")) return;
    await api("/api/products/"+id, { method:"DELETE" });
    await load();
  }

  $("btnSave").onclick = async ()=>{
    $("msg").textContent="";
    try{
      const payload = {
        code: $("code").value.trim(),
        name: $("name").value.trim(),
        lab: $("lab").value.trim(),
        location: $("location").value.trim(), // â¬…ï¸ nuevo
        stock: Number($("stock").value||0),
        buy_price: Number($("buy_price").value||0),
        sell_price: Number($("sell_price").value||0),
        expiry_date: $("expiry_date").value.trim() || null
      };

      const id = $("id").value;
      if(id){
        await api("/api/products/"+id, { method:"PUT", body: JSON.stringify(payload) });
      }else{
        await api("/api/products", { method:"POST", body: JSON.stringify(payload) });
      }
      clearForm();
      await load();
    }catch(e){
      $("msg").textContent = e.message;
    }
  };

  function clearForm(){
    $("id").value="";
    $("code").value="";
    $("name").value="";
    $("lab").value="";
    $("location").value="";
    $("stock").value="0";
    $("buy_price").value="0";
    $("sell_price").value="0";
    $("expiry_date").value="";
  }

  $("btnClear").onclick = clearForm;
  $("search").oninput = ()=>load();

  load();
</script>
</body>
</html>
