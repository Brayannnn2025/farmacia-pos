<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard | POS Farmacia</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}
    @media(max-width:980px){.kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:560px){.kpi-grid{grid-template-columns:1fr;}}
    .kpi{padding:16px;border-radius:14px;border:1px solid #e5e7eb;background:#fff}
    .kpi .t{font-size:12px;color:#64748b}
    .kpi .v{font-size:26px;font-weight:800;margin-top:6px}
    .kpi .s{font-size:12px;color:#64748b;margin-top:6px}
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr;}}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f8fafc}
    .danger{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    .warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
    th{font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.04em}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .btn2{padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-weight:700;cursor:pointer}
    .btn2.primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  </style>
</head>
<body>

<header class="top">
  <div>
    <div class="brand">POS Farmacia</div>
    <div class="small">Dashboard · Alertas · Exportar Excel</div>
  </div>

  <nav class="links">
    <a class="link" href="pos.html">Caja</a>
    <a class="link" href="ventas.html">Historial</a>
    <a class="link" href="admin_productos.html" data-role="admin">Productos</a>
    <a class="link" href="usuarios.html" data-role="admin">Usuarios</a>
    <button class="btn" onclick="logout()">Salir</button>
  </nav>
</header>

<div class="container" style="margin-top:18px;">
  <div class="kpi-grid">
    <div class="kpi">
      <div class="t">Ventas (Hoy)</div>
      <div class="v" id="kpiSalesToday">—</div>
      <div class="s" id="kpiSalesTodayS">Total S/</div>
    </div>
    <div class="kpi">
      <div class="t">Transacciones (Hoy)</div>
      <div class="v" id="kpiTxToday">—</div>
      <div class="s">Cantidad de ventas</div>
    </div>
    <div class="kpi">
      <div class="t">Stock bajo</div>
      <div class="v" id="kpiLow">—</div>
      <div class="s">Productos con stock &lt; 5</div>
    </div>
    <div class="kpi">
      <div class="t">Por vencer</div>
      <div class="v" id="kpiExp">—</div>
      <div class="s">Próximos 30 días</div>
    </div>
  </div>

  <div class="actions">
    <button class="btn2 primary" onclick="location.href='pos.html'">Ir a Caja</button>
    <button class="btn2" onclick="location.href='admin_productos.html'" data-role="admin">Gestionar Productos</button>
    <button class="btn2" onclick="location.href='ventas.html'">Ver Historial</button>
    <button class="btn2" onclick="downloadExcel('/api/export/products.xlsx','inventario.xlsx')" data-role="admin">Excel Inventario</button>
    <button class="btn2" onclick="downloadExcel('/api/export/sales.xlsx','ventas.xlsx')">Excel Ventas</button>
  </div>

  <div class="grid2" style="margin-top:14px;">
    <section class="card">
      <h2>Alertas de stock bajo</h2>
      <div class="small" id="lowInfo">—</div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr><th>Código</th><th>Producto</th><th>Stock</th><th>Ubicación</th><th>Estado</th></tr>
          </thead>
          <tbody id="lowBody"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Productos por vencer</h2>
      <div class="small" id="expInfo">—</div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr><th>Código</th><th>Producto</th><th>Vence</th><th>Ubicación</th><th>Estado</th></tr>
          </thead>
          <tbody id="expBody"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script src="app.js"></script>
<script>
  requireAuth(["admin","cajero"]);
  applyRoleVisibility();

  const LOW_LIMIT = 5;
  const EXP_DAYS = 30;

  function badge(text, cls){ return `<span class="badge ${cls||''}">${text}</span>`; }

  async function loadDashboard(){
    // KPIs
    const sum = await api(`/api/dashboard/summary?low=${LOW_LIMIT}&days=${EXP_DAYS}`);
    $("kpiSalesToday").textContent = "S/ " + money(sum.sales_today_total || 0);
    $("kpiTxToday").textContent = String(sum.sales_today_count || 0);
    $("kpiLow").textContent = String(sum.low_stock_count || 0);
    $("kpiExp").textContent = String(sum.expiring_count || 0);

    // Low stock list
    const low = await api(`/api/alerts/low-stock?limit=${LOW_LIMIT}`);
    $("lowInfo").textContent = `Mostrando ${low.count} productos con stock < ${LOW_LIMIT}`;
    $("lowBody").innerHTML = low.items.map(p=>{
      const cls = (p.stock<=0) ? "danger" : "warn";
      const st = (p.stock<=0) ? badge("SIN STOCK", "danger") : badge("BAJO", "warn");
      return `<tr>
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td><b>${p.stock}</b></td>
        <td>${p.location||""}</td>
        <td>${st}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="5" class="small">Sin alertas ✅</td></tr>`;

    // Expiring list
    const exp = await api(`/api/alerts/expiring?days=${EXP_DAYS}`);
    $("expInfo").textContent = `Vencen dentro de ${EXP_DAYS} días: ${exp.count}`;
    $("expBody").innerHTML = exp.items.slice(0,50).map(p=>{
      const cls = p.is_expired ? "danger" : "warn";
      const st = p.is_expired ? badge("VENCIDO", "danger") : badge("POR VENCER", "warn");
      return `<tr>
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td><b>${p.expiry_date}</b></td>
        <td>${p.location||""}</td>
        <td>${st}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="5" class="small">Sin alertas ✅</td></tr>`;
  }

  loadDashboard().catch(e=>alert(e.message));
</script>
</body>
</html>
