<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard | POS Farmacia</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    .kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}
    @media(max-width:980px){.kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:560px){.kpi-grid{grid-template-columns:1fr;}}
    .kpi{padding:16px;border-radius:14px;border:1px solid #e5e7eb;background:#fff}
    .kpi .t{font-size:12px;color:#64748b}
    .kpi .v{font-size:26px;font-weight:800;margin-top:6px}
    .kpi .s{font-size:12px;color:#64748b;margin-top:6px}
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr;}}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f8fafc}
    .danger{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    .warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
    th{font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.04em}

    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

    /* ‚úÖ FIX PRINCIPAL:
       En tu styles.css probablemente hay button { color:#fff; }.
       Entonces el texto de .btn2 se vuelve blanco y se "pierde" sobre fondo blanco.
       Aqu√≠ lo forzamos a oscuro. */
    .btn2{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;

      /* üî• Fuerza texto visible */
      color:#0f172a !important;

      font-weight:700;
      cursor:pointer;

      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;

      line-height:1;
      white-space:nowrap;
    }
    .btn2.primary{
      background:#0ea5e9;
      border-color:#0ea5e9;

      /* Solo el primary debe ser blanco */
      color:#fff !important;
    }

    /* Export */
    .export-grid{
      display:grid;
      grid-template-columns: 160px 220px 220px auto; /* ‚úÖ el √∫ltimo auto, NO 1fr */
      gap:10px;
      align-items:center;
    }
    @media(max-width:980px){
      .export-grid{grid-template-columns:1fr;}
    }

    /* ‚úÖ Los botones de export NO deben estirarse ni tener min-width grande */
    .export-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .export-actions .btn2{
      min-width:0 !important; /* ‚úÖ quita el estiramiento */
      width:auto !important;
    }

    /* ‚úÖ FORZAR VISIBILIDAD DEL BOT√ìN INVENTARIO (por si styles.css lo ‚Äúrompe‚Äù) */
    #btnInv{
      background:#fff !important;
      color:#0f172a !important;
      border:1px solid #e5e7eb !important;
      opacity:1 !important;
      visibility:visible !important;
      font-size:14px !important;
      line-height:1 !important;
    }
  </style>
</head>

<body>

<header class="top">
  <div>
    <div class="brand">POS Farmacia</div>
    <div class="small">Dashboard ¬∑ Alertas ¬∑ Exportar Excel</div>
  </div>

  <nav class="links">
    <a class="link" href="pos.html">Caja</a>
    <a class="link" href="ventas.html">Historial</a>
    <a class="link" href="admin_productos.html" data-role="admin">Productos</a>
    <a class="link" href="usuarios.html" data-role="admin">Usuarios</a>
    <button class="btn" onclick="logout()">Salir</button>
  </nav>
</header>

<div class="container" style="margin-top:18px;">

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="t">Ventas (Hoy)</div>
      <div class="v" id="kpiSalesToday">‚Äî</div>
      <div class="s">Total S/</div>
    </div>
    <div class="kpi">
      <div class="t">Transacciones (Hoy)</div>
      <div class="v" id="kpiTxToday">‚Äî</div>
      <div class="s">Cantidad de ventas</div>
    </div>
    <div class="kpi">
      <div class="t">Stock bajo</div>
      <div class="v" id="kpiLow">‚Äî</div>
      <div class="s">Productos con stock &lt; 5</div>
    </div>
    <div class="kpi">
      <div class="t">Por vencer</div>
      <div class="v" id="kpiExp">‚Äî</div>
      <div class="s">Pr√≥ximos 30 d√≠as</div>
    </div>
  </div>

  <!-- Acciones r√°pidas -->
  <div class="actions">
    <button class="btn2 primary" type="button" onclick="location.href='pos.html'">Ir a Caja</button>
    <button class="btn2" type="button" onclick="location.href='admin_productos.html'" data-role="admin">Gestionar Productos</button>
    <button class="btn2" type="button" onclick="location.href='ventas.html'">Ver Historial</button>
  </div>

  <!-- EXPORTAR EXCEL -->
  <section class="card" style="margin-top:14px;">
    <h2 style="margin-bottom:6px;">Exportar Excel</h2>
    <div class="small" style="margin-bottom:10px;">Inventario completo o ventas por rango.</div>

    <div class="export-grid">
      <div class="small muted">Ventas por rango:</div>

      <input id="expFrom" type="date" />
      <input id="expTo" type="date" />

      <div class="export-actions">
        <!-- Inventario solo admin (lo ocultamos por JS) -->
        <button class="btn2" id="btnInv" type="button">Descargar Inventario</button>

        <!-- Ventas -->
        <button class="btn2 primary" id="btnSales" type="button">Descargar Ventas</button>
      </div>
    </div>
  </section>

  <!-- Tablas -->
  <div class="grid2" style="margin-top:14px;">
    <section class="card">
      <h2>Alertas de stock bajo</h2>
      <div class="small" id="lowInfo">‚Äî</div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr><th>C√≥digo</th><th>Producto</th><th>Stock</th><th>Ubicaci√≥n</th><th>Estado</th></tr>
          </thead>
          <tbody id="lowBody"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Productos por vencer</h2>
      <div class="small" id="expInfo">‚Äî</div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr><th>C√≥digo</th><th>Producto</th><th>Vence</th><th>Ubicaci√≥n</th><th>Estado</th></tr>
          </thead>
          <tbody id="expBody"></tbody>
        </table>
      </div>
    </section>
  </div>

</div>

<script src="app.js"></script>
<script>
  requireAuth(["admin","cajero"]);
  applyRoleVisibility();

  const LOW_LIMIT = 5;
  const EXP_DAYS = 30;

  function badge(text, cls){ return `<span class="badge ${cls||''}">${text}</span>`; }

  function ymd(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const dd = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  // Defaults fechas
  const today = ymd(new Date());
  const expFrom = document.getElementById("expFrom");
  const expTo = document.getElementById("expTo");
  if (expFrom && !expFrom.value) expFrom.value = today;
  if (expTo && !expTo.value) expTo.value = today;

  // Mostrar inventario solo si admin
  const btnInv = document.getElementById("btnInv");
  if (btnInv) {
    if (!isAdmin()) {
      btnInv.style.display = "none";
    } else {
      btnInv.addEventListener("click", async (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const filename = `inventario_${ymd(new Date())}.xlsx`;
        await downloadExcel("/api/export/inventory.xlsx", filename);
      });
    }
  }

  // Descargar ventas SOLO al click del bot√≥n
  const btnSales = document.getElementById("btnSales");
  if (btnSales) {
    btnSales.addEventListener("click", async (e)=>{
      e.preventDefault();
      e.stopPropagation();
      const f = expFrom?.value || "";
      const t = expTo?.value || "";
      const params = new URLSearchParams();
      if (f) params.set("from", f);
      if (t) params.set("to", t);
      const filename = `ventas_${f || "all"}_${t || "all"}.xlsx`;
      await downloadExcel("/api/export/sales.xlsx?" + params.toString(), filename);
    });
  }

  async function loadDashboard(){
    const sum = await api(`/api/dashboard/summary?threshold=${LOW_LIMIT}&days=${EXP_DAYS}`);

    document.getElementById("kpiSalesToday").textContent = "S/ " + money(sum?.today?.total || 0);
    document.getElementById("kpiTxToday").textContent = String(sum?.today?.count || 0);
    document.getElementById("kpiLow").textContent = String(sum?.low_stock?.count || 0);
    document.getElementById("kpiExp").textContent = String(sum?.expiring?.count || 0);

    const low = await api(`/api/alerts/low-stock?threshold=${LOW_LIMIT}`);
    document.getElementById("lowInfo").textContent = `Mostrando ${low.count} productos con stock <= ${LOW_LIMIT}`;
    document.getElementById("lowBody").innerHTML =
      (low.items || []).map(p=>{
        const st = (p.stock<=0) ? badge("SIN STOCK", "danger") : badge("BAJO", "warn");
        return `<tr>
          <td>${p.code}</td>
          <td>${p.name}</td>
          <td><b>${p.stock}</b></td>
          <td>${p.location||""}</td>
          <td>${st}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="small">Sin alertas ‚úÖ</td></tr>`;

    const exp = await api(`/api/alerts/expiring?days=${EXP_DAYS}`);
    document.getElementById("expInfo").textContent = `Vencen dentro de ${EXP_DAYS} d√≠as: ${exp.count}`;
    document.getElementById("expBody").innerHTML =
      (exp.items || []).slice(0,50).map(p=>{
        const st = badge("POR VENCER", "warn");
        return `<tr>
          <td>${p.code}</td>
          <td>${p.name}</td>
          <td><b>${p.expiry_date || ""}</b></td>
          <td>${p.location||""}</td>
          <td>${st}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="small">Sin alertas ‚úÖ</td></tr>`;
  }

  loadDashboard().catch(e=>alert(e.message));
</script>
</body>
</html>
